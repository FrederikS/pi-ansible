---
- name: Check if autocomplete is installed
  lineinfile:
    path: ~/.bashrc
    line: complete -C /usr/local/bin/terraform terraform
    state: absent
  check_mode: yes
  register: tf_autocomplete
  changed_when: tf_autocomplete.found == 0

- name: Install terraform autocomplete
  command: terraform -install-autocomplete
  when: tf_autocomplete.found == 0

- name: Install tmux
  become: yes
  become_user: root
  package:
    name: tmux
    state: present

- name: Install tpm
  git:
    repo: https://github.com/tmux-plugins/tpm
    dest: ~/.tmux/plugins/tpm
    update: no
    version: master

- name: Add tmux config
  template:
    src: "tmux.conf.j2"
    dest: "~/.tmux.conf"
    owner: fdk
    group: fdk
    mode: 0644

- name: Enable helm autocomplete
  lineinfile:
    path: ~/.bashrc
    line: source <(helm completion bash)
    state: present

- name: Enable aws autocomplete
  lineinfile:
    path: ~/.bashrc
    line: complete -C '/usr/local/bin/aws_completer' aws
    state: present

- name: Ensures .kube dir exists
  file:
    path: ~/.kube
    state: directory
    owner: fdk
    group: fdk
    mode: 0755

- name: Copy kube config
  become: yes
  become_user: root
  copy:
    src: "{{ kube_config_path }}"
    dest: "/home/fdk/.kube/config"
    remote_src: yes
    owner: fdk
    group: fdk
    mode: 0600

- name: Export KUBECONFIG
  lineinfile:
    path: ~/.profile
    line: "export KUBECONFIG=~/.kube/config"
    state: present

- name: Enable istio autocomplete
  lineinfile:
    path: ~/.bashrc
    line: source <(istioctl completion bash)
    state: present